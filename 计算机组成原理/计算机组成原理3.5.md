### 3.5 总线控制

主要包括判优控制（或称仲裁逻辑）和通信控制

#### 3.5.1 总线判优控制

总线上所连接的各类设备，按其对总线有无控制功能可以分为主设备和从设备两种。

主设备对总线有控制权，从设备只能响应从主设备发来的总线命令。

若多个主设备同时要使用总线时，就由总线控制器的判优、仲裁逻辑按一定的优先等级顺序，确定哪个主设备能使用总线。

总线判优控制可分集中式和分布式两种，前者将控制逻辑集中在一处（如在CPU中），后者将控制逻辑分散在与总线连接的各个部件或设备上。

常见的集中控制有三种有限权仲裁方式：

1. 链式查询

   在查询链中，离总线控制部件最近的设备具有最高的优先级，这种方式的特点是：只需很少几根线就能按一定优先次序实现总线控制，并且很容易扩充设备，但对电路故障很敏感。

2. 计数器定时查询

   多一组设备地址线，少一根总线同意线BG。

   总线控制部件接到由BR送来的总线请求信号后，在总线未被使用（BS=0）的情况下，由计数器开始计数，向各设备发出一组地址信号。当某个有总线请求的设备地址与计数器一致时，便获得总线使用权，此时终止技术查询。

   这种方式的特点是：计数可以从“0”开始，此时设备的优先次序是固定的；计数也可以从终止点开始，即是一种循环方法，此时设备使用总线的优先级相等；计数器的初始值还可以由程序设置，故优先次序可以改变。此外，对电路故障不如链式查询方式敏感，但增加了主线控制（设备地址）数，控制也较复杂。

3. 独立请求方式

   每一设备均有一对总线请求线和总线同意线。

   总线控制部件中有一排队电路，可根据优先次序确定响应哪一设备的请求。

   这种方式的特点是：响应速度快，优先次序控制灵活（通过程序改变），但控制线数量多，总线控制更复杂。

#### 3.5.2 总线通信控制

在争夺总线使用权时，只能按各部件的优先等级来解决。而在传送通信时间上，只能按分时方式来解决。

即哪一个部件获得使用，此刻就由它传送，下一部件获得使用，接着下一时刻传送。

总线在完成一次传输周期时，可分为四个阶段：

- 申请分配阶段

  由某个主设备或主模块提出申请，经总线判优决定下一传输周期使用权的归属

- 寻址阶段

  取得使用权的主模块，通过主线发出本次打算访问的从模块或从设备的存储地址或设备地址及有关命令，启动参与本次传输的从模块。

- 传数阶段

  主从模块进行数据交换，数据由源模块发出经数据总线流入目的模块

- 结束阶段

  主模块有关信息从系统总线上撤除，让出总线使用权。

总线通信控制主要解决通信双方如何获知传输开始和传输结束，以及通信双方协调如何配合。一般常用四种方式：同步通信、异步通信、半同步通信和分离式通信。

1. 同步通信

   通信双方由统一时标控制数据传送成为同步通信。时标通常由CPU的总线控制部件发出，达到总线上的所有部件；也可以由每个部件各自的时序发生器发出，但必须由总线控制部件发出的时钟信号对他们进行同步。

   这种通信的优点是规定明确、统一，模块间的配合简单一致。缺点是主从模块时间配合属性强制性“同步”，必须在限定时间内完成规定要求。并且对所有从模块都用同一限时，势必造成对不同速度的部件而言，必须按最慢速度部件来设计公共时钟，严重影响总线的工作效率，也给设计带来了局限性，缺乏灵活性。

   同步通信一般用于总线长度较短，各部件存取时间比较一致的场合。

2. 异步通信

   克服了同步通信的缺点，允许各模块速度的不一致性，给设计者充分的灵活性和选择余地。

   它没有公共的时钟标准，不要求所有部件严格的统一动作时间，而是采用应答方式（又称握手方式），即主模块发出请求信号，等从模块反馈响应后才开始通信。这要求主从模块之间增加两条应答线（handshaking）

   异步通信方式可分为不互锁，半互锁和全互锁三种。

   - 不互锁

     主模块放出信号后不等待回答信号，而是一段时间后确认从模块已收到信号后便撤销其请求信号

     从设备接到请求信号后，在条件允许时发出回答信号，并经过一段时间确认主设备已收到回答信号后，自动撤销回答信号。可见双方并无互锁关系（双方都说了，听不听无所谓）

   - 半互锁

     主模块发出请求信号，待接到从模块回答后再撤销其请求信号，存在简单的互锁关系；而从模块发出回答信号后，不等待主模块回答，一段时间后便撤销，无互锁关系。（主模块要听到回应才办事，从模块过段时间直接办事）

   - 全互锁

     主模块发出请求信号，从模块回答后再撤销其请求信号；从模块发出回答信号，主模块获知后，再撤销其回答信号。

3. 半同步通信

   集同步与异步之优点，既保留同步的基本特点，如所有的地址、命令、数据信号的发出时间，都严格参照系统时钟的某个前沿开始，而接收方都采用系统时钟后沿时刻来进行判断识别。同时又像异步通信一样，允许不同速度的模块和谐工作。为此增设一条“等待”（WAIT）响应信号线。（简而言之，等你好了再走下一步）

   半同步通信适用于系统工作速度不高，但又包含了许多工作速度差异较大的各类设备的简单系统。半同步通信控制方式比异步通信简单，在全系统内各模块又在统一的系统时钟控制下同步工作，可靠性较高，同步结构较方便。其缺点是对系统时钟频率不能要求太高。

4. 分离式通信

   基本思想是将一个传输周期（或总线周期）分解为两个子周期。

   第一个子周期，主模块A获得总线使用权后将命令、地址以及其他有关信息发到总线上，经总线传输后，由有关的从模块B接受下来，一发送完，立即放弃总线使用权，以便其他模块使用。

   第二个子周期中，当B收到A的相关命令后，经选择、译码、读取等一系列内部操作，将A模块所需的数据准备好，便由B模块申请总线使用权，一但获准，B模块便将A模块的编号、B模块的地址，A模块所需的数据等一系列信息送到总线上，供A模块接收。很明显，上述两个子周期都只有单方向的信息流，每个模块都成为了主模块。

   这种通信方式的特点是：

   - 各模块欲占用总线使用权都必须提出申请
   - 得到总线使用权后，主模块在限定的时间内向对方传送信息，采用同步方式传送，不再等待对方的回答信号
   - 各模块在准备数据传送的过程中都不占用总线，总线可接受其他模块的请求
   - 总线被占用时都在有效工作，或通过它发命令，或通过它传送数据，不存在空闲等待时间，充分发挥了总线的有效占用。

   实现了总线为多个主从模块间进行信息交叉重叠并行式传送，这对大型计算机系统极为重要，但这种方式控制较复杂，在普通微机系统很少采用。